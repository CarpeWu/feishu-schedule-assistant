# **æ™ºèƒ½åŒæ—¥æŠ¥ç®¡ç†ç³»ç»Ÿ - APIé…ç½®æ–‡æ¡£ v1.2.0**

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   n8n Server     â”‚â—„â”€â”€â”€(Events)â”€â”€â”€â”€â–ºâ”‚   Lark Feishu    â”‚     â”‚  Database        â”‚
â”‚   (Docker)       â”‚                    â”‚   API Gateway    â”‚â—„â”€â”€â”€â–ºâ”‚  Bitable         â”‚
â”‚   DeepSeek V3    â”‚â”€â”€â”€â”€(AI Analysis)â”€â”€â–ºâ”‚   OpenRouter     â”‚     â”‚  (T1-T7 Tables)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
## ğŸ”‘ è®¤è¯ä¿¡æ¯

### n8n è®¤è¯

| **é¡¹ç›®**       | **å€¼**                                                       | **ç”¨é€”**         |
| :------------- | :----------------------------------------------------------- | :--------------- |
| **æœåŠ¡å™¨åœ°å€** | `http://127.0.0.1:5678`                                 | n8nç®¡ç†ç•Œé¢å’ŒAPI |
| **APIå¯†é’¥**    | `YOUR_N8N_API_KEY` | APIè®¿é—®è®¤è¯      |
| **APIè°ƒç”¨å¤´**  | `X-N8N-API-KEY: {key}`                                       | APIè¯·æ±‚å¤´æ ¼å¼    |

### é£ä¹¦ Feishu è®¤è¯

| **é¡¹ç›®**                    | **å€¼**                                                       | **ç”¨é€”**        |
| :-------------------------- | :----------------------------------------------------------- | :-------------- |
| **App ID**                  | `cli_xxxxxxxxxxxxxxxx`                                       | åº”ç”¨æ ‡è¯†        |
| **App Secret**              | `xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`                           | åº”ç”¨å¯†é’¥        |
| **Tenant Access Token API** | `https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal` | è·å–è®¿é—®ä»¤ç‰Œ    |
| **æƒé™çŠ¶æ€**                | è¯»å–âœ… å†™å…¥âœ…                                                  | å½“å‰APIæƒé™çŠ¶æ€ |

### OpenRouter (AI) è®¤è¯

| **é¡¹ç›®** | **å€¼** | **ç”¨é€”** |
| :--- | :--- | :--- |
| **Base URL** | `https://openrouter.ai/api/v1` | AI æ¨¡å‹æ¥å£ |
| **Model** | `deepseek/deepseek-chat-v3.1` | DeepSeek V3 æ¨¡å‹ |

## ğŸ—„ï¸ æ•°æ®åº“é…ç½® (Lark Bitable)

### Base App ä¿¡æ¯

| **é¡¹ç›®**           | **å€¼**                        | **è¯´æ˜**     |
| :----------------- | :---------------------------- | :----------- |
| **Base App Token** | `QXRxxxxxxxxxxxxxxxxxxxx` | Baseåº”ç”¨æ ‡è¯† |
| **Baseåç§°**       | æ™ºèƒ½åŒæ—¥æŠ¥ç®¡ç†ç³»ç»Ÿ            | ä¸»è¦æ•°æ®å­˜å‚¨ |

### æ•°æ®è¡¨ç»“æ„ (v1.2.0 æ¶æ„)

| **è¡¨ID (TID)**              | **è¡¨å**       | **ç”¨é€”**                 | **å…³é”®å­—æ®µ (v1.2.0)**                                     |
| :-------------------------- | :------------- | :----------------------- | :----------------------------------------------------------- |
| **T1** (`tblMissedLogxxxx`) | æ¼å†™è®°å½•è¡¨     | å­˜å‚¨æ¼å†™å’Œè¡¥äº¤çŠ¶æ€       | **missed\_log\_id (ä¸»é”®)**, employee\_ref, missed\_date, status |
| **T2** (`tblDailyReportxx`) | æ—¥æŠ¥å†…å®¹è¡¨     | å­˜å‚¨æ‰€æœ‰æäº¤çš„æ—¥æŠ¥       | **daily\_report\_id (ä¸»é”®)**, employee\_ref, report\_date, submission\_type |
| **T3** (`tblAIAnalysisxxx`) | AIåˆ†ææ±‡æ€»è¡¨   | å­˜å‚¨ AI åˆ†æç»“æœ         | **analysis\_id (ä¸»é”®)**, target\_id, period\_start\_date, summary |
| **T4** (`tblScheduleLogxx`) | æ¯æ—¥æ’ç­è®°å½•è¡¨ | è¿‡ç¨‹è¿½æº¯ä¸æ—¥å¿—           | **schedule\_log\_id (ä¸»é”®)**, schedule\_date, employee\_ref, status |
| **T5** (`tblEmployeexxxxx`) | å‘˜å·¥ä¿¡æ¯è¡¨     | å­˜å‚¨å‘˜å·¥æ¡£æ¡ˆã€æ’ç­ã€çŠ¶æ€ | **employee\_id (ä¸»é”®)**, employee\_person, open\_id, status, shift\_template |
| **T6** (`tblSpecialSchexx`) | ç‰¹æ®Šæ—¥ç¨‹è¡¨     | å­˜å‚¨è¯·å‡ã€èŠ‚å‡æ—¥ç­‰ä¾‹å¤–   | **special\_schedule\_id (ä¸»é”®)**, employee\_ref, schedule\_change\_date |
| **T7** (`tblConfigxxxxxxx`) | ç³»ç»Ÿé…ç½®å‚æ•°è¡¨ | å­˜å‚¨å·¥ä½œæµåŠ¨æ€å‚æ•°       | **config\_id (ä¸»é”®)**, parameter\_name, parameter\_value, category |

## ğŸ”§ feishu-nodes-lite é…ç½®ä¼˜åŒ–

### æ¨èèŠ‚ç‚¹é…ç½®æ¨¡å¼

#### 1. è®¤è¯èŠ‚ç‚¹é…ç½®

```json
{
  "nodeType": "feishu-nodes-lite.tenantAccessToken",
  "parameters": {
    "app_id": "cli_xxxxxxxxxxxxxxxx",
    "app_secret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  }
}```

#### 2. æ•°æ®æŸ¥è¯¢èŠ‚ç‚¹é…ç½® (æ¨èä½¿ç”¨)

```json
{
  "nodeType": "feishu-nodes-lite.recordsSearch",
  "parameters": {
    "app_token": "QXRxxxxxxxxxxxxxxxxxxxx",
    "table_id": "tbl{{TABLE_ID}}",
    "search_criteria": {
      "filter": {
        "conjunction": "AND",
        "conditions": [
          {
            "field_name": "{{field_name}}",
            "operator": "is",
            "value": ["{{value}}"]
          }
        ]
      }
    }
  }
}
```

#### 3. æ•°æ®å†™å…¥èŠ‚ç‚¹é…ç½®

```json
{
  "nodeType": "feishu-nodes-lite.recordsAdd",
  "parameters": {
    "app_token": "QXRxxxxxxxxxxxxxxxxxxxx",
    "table_id": "tbl{{TABLE_ID}}",
    "fields": {
      "field_name": "field_value"
    }
  }
}
```

### å­—æ®µæ•°æ®æ ¼å¼è§„èŒƒ (v1.2.0)

| **å­—æ®µç±»å‹** | **æ•°æ®æ ¼å¼**                              | **ç¤ºä¾‹**                    | **æ³¨æ„äº‹é¡¹**        |
| :----------- | :---------------------------------------- | :-------------------------- | :------------------ |
| **äººå‘˜å­—æ®µ** | `[{ "id": "ou_xxx" }]`                    | `[{ "id": "ou_123456" }]`   | å¿…é¡»ä½¿ç”¨Open IDæ ¼å¼ |
| **å…³è”å­—æ®µ** | `["recXXXXX"]`                            | `["rec12345"]`              | ä½¿ç”¨è®°å½•IDæ•°ç»„      |
| **æ—¥æœŸå­—æ®µ** | æ¯«ç§’æ—¶é—´æˆ³                                | `1703001600000`             | UTCæ—¶é—´æˆ³æ ¼å¼       |
| **æ—¥æœŸç­›é€‰** | `["Today"]` æˆ– `["ExactDate", timestamp]` | `["Today"]`                 | æ”¯æŒå®˜æ–¹ç­›é€‰æ ¼å¼    |
| **é“¾æ¥å­—æ®µ** | `{ "link": "url" }`                       | `{ "link": "https://xxx" }` | é“¾æ¥å¯¹è±¡æ ¼å¼        |
| **å¤šé€‰å­—æ®µ** | `["option1", "option2"]`                  | `["å·²å®Œæˆ", "è¿›è¡Œä¸­"]`      | é€‰é¡¹åç§°æ•°ç»„        |

## ğŸ”§ å·¥ä½œæµé…ç½® (v1.2.0)

### æ ¸å¿ƒå·¥ä½œæµåˆ—è¡¨

| **å·¥ä½œæµID**       | **å·¥ä½œæµåç§°**                 | **è§¦å‘æ–¹å¼**        | **æ‰§è¡Œé¢‘ç‡/æ¡ä»¶**                |
| :----------------- | :----------------------------- | :------------------ | :------------------------------- |
| `WORKFLOW_ID_01_PLACEHOLDER` | [WF-01] æ’ç­è®¡ç®—å¼•æ“æ¨¡å—       | å®šæ—¶è§¦å‘            | æ¯æ—¥ **20:00**                   |
| `WORKFLOW_ID_02_PLACEHOLDER` | [WF-02] æé†’ä¸é€šçŸ¥æœåŠ¡æ¨¡å—     | å®šæ—¶è§¦å‘            | æ¯æ—¥ 21:00 / 22:00 / 23:00       |
| `WORKFLOW_ID_03_PLACEHOLDER` | [WF-03] æ¼å†™åˆ¤å®šä¸è®°å½•æœåŠ¡æ¨¡å— | å®šæ—¶è§¦å‘            | **æ¬¡æ—¥ 08:00**                   |
| `WORKFLOW_ID_04_PLACEHOLDER` | [WF-04] ç»Ÿä¸€æäº¤å¤„ç†æ¨¡å—-event | Webhook (Event)     | **å®æ—¶** (ç›‘å¬ T2, T5 å˜æ›´)      |
| `WORKFLOW_ID_05_PLACEHOLDER` | [WF-05] AIåˆ†ææœåŠ¡æ¨¡å—         | å®šæ—¶è§¦å‘            | æ¯æ—¥ 09:00 (ä»£ç æ§åˆ¶**å‘¨ä¸€/1å·**æ‰§è¡Œ) |
| `WORKFLOW_ID_06_PLACEHOLDER` | [WF-06] å‘¨äº”èµä¼‘æé†’æœåŠ¡       | å®šæ—¶è§¦å‘            | æ¯å‘¨äº” 19:00                     |

### æ—¶åŒºé…ç½®çŠ¶æ€

*   **ç›®æ ‡æ—¶åŒº**: `Asia/Shanghai` (ä¸œå…«åŒº)
*   **é…ç½®æ–¹å¼**: åœ¨ n8n çš„ `Schedule Trigger` èŠ‚ç‚¹ä¸­æ˜ç¡®è®¾ç½® "timezone": "Asia/Shanghai"

## ğŸŒ API ç«¯ç‚¹

### n8n Webhook (WF-04)

| **ç”¨é€”** | **æ–¹æ³•** | **URL Path (UUID)** | **è¯´æ˜** |
| :--- | :--- | :--- | :--- |
| **é£ä¹¦äº‹ä»¶è®¢é˜…åœ°å€** | POST | `/webhook/WEBHOOK_UUID_PLACEHOLDER_2` | éœ€åœ¨é£ä¹¦å¼€æ”¾å¹³å°é…ç½®æ­¤åœ°å€ï¼Œå¹¶è®¢é˜… `bitable.record.changed` äº‹ä»¶ |

### n8n API (Legacy)

| **ç«¯ç‚¹**                 | **æ–¹æ³•** | **ç”¨é€”**                 |
| :----------------------- | :------- | :----------------------- |
| `/api/v1/workflows`      | GET      | è·å–å·¥ä½œæµåˆ—è¡¨           |
| `/api/v1/workflows/{id}` | GET/PUT  | è·å–/æ›´æ–°ç‰¹å®šå·¥ä½œæµ      |

### é£ä¹¦ API (feishu-nodes-lite ä¼˜åŒ–)

| **æ¨èèŠ‚ç‚¹**                           | **ç”¨é€”**     | **æ›¿ä»£ä¼ ç»ŸAPI** |
| :------------------------------------- | :----------- | :-------------- |
| `feishu-nodes-lite.recordsSearch`      | æŸ¥è¯¢è®°å½•     | GET /records    |
| `feishu-nodes-lite.recordsAdd`         | æ·»åŠ è®°å½•     | POST /records   |
| `feishu-nodes-lite.recordsUpdate`      | æ›´æ–°è®°å½•     | PUT /records    |
| `feishu-nodes-lite.recordsBatchUpdate` | æ‰¹é‡æ›´æ–°è®°å½• | PATCH /records  |
| `feishu-nodes-lite.messagesSend`       | å‘é€æ¶ˆæ¯     | POST /messages  |

## ğŸ“Š ç³»ç»Ÿé…ç½®å‚æ•° (T7 è¡¨æ ¸å¿ƒ)

| **å‚æ•°å (parameter\_name)** | **å»ºè®®å€¼ (parameter\_value)** | **æè¿° (description)**                 |
| :--------------------------- | :---------------------------- | :------------------------------------- |
| `daily_reminder_time`        | `21:00`                       | [WF-02] æ¯æ—¥æé†’å¼€å§‹æ—¶é—´ (HH:mm)       |
| `reminder_interval_minutes`  | `60`                          | [WF-02] æé†’å¾ªç¯é—´éš” (åˆ†é’Ÿ)            |
| `missed_deadline_time`       | `08:00`                       | [WF-03] æ¼å†™åˆ¤å®šæˆªæ­¢æ—¶é—´ (HH:mm)       |
| `ai_analysis_cycle_days`     | `7`                           | [WF-05] AI åˆ†æå‘¨æœŸ (å¤©)               |
| `ai_analysis_trigger_day`    | `1`                           | [WF-05] AI åˆ†æè§¦å‘æ—¥ (1=å‘¨ä¸€, 7=å‘¨æ—¥) |

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### API è°ƒç”¨ä¼˜åŒ–

1.  **æ‰¹é‡æ“ä½œ**: ä½¿ç”¨ `recordsBatchUpdate` èŠ‚ç‚¹è¿›è¡Œæ‰¹é‡æ›´æ–°
2.  **åˆ†é¡µæŸ¥è¯¢**: è®¾ç½® `page_size` å‚æ•°æ§åˆ¶è¿”å›æ•°æ®é‡
3.  **å­—æ®µç­›é€‰**: ä»…æŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
4.  **ç¼“å­˜æœºåˆ¶**: åœ¨ n8n ä¸­ä½¿ç”¨ç¼“å­˜èŠ‚ç‚¹å­˜å‚¨é¢‘ç¹è®¿é—®çš„æ•°æ®

### å·¥ä½œæµæ‰§è¡Œä¼˜åŒ–

1.  **å¹¶è¡Œå¤„ç†**: ä½¿ç”¨ `Split in batches` èŠ‚ç‚¹å¹¶è¡Œå¤„ç†å¤šæ¡è®°å½•
2.  **é”™è¯¯é‡è¯•**: é…ç½®é€‚å½“çš„é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
3.  **èµ„æºç›‘æ§**: ç›‘æ§å·¥ä½œæµæ‰§è¡Œæ—¶é—´å’Œèµ„æºæ¶ˆè€—

## ğŸ› ï¸ é”™è¯¯å¤„ç†æŒ‡å—

### å¸¸è§é”™è¯¯ç±»å‹

| **é”™è¯¯ä»£ç **       | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ**                     |
| :----------------- | :----------- | :------------------------------- |
| `400 Bad Request`  | å­—æ®µæ ¼å¼é”™è¯¯ | æ£€æŸ¥å­—æ®µæ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆè§„èŒƒ     |
| `401 Unauthorized` | è®¤è¯å¤±è´¥     | æ£€æŸ¥App ID/Secretæˆ–Tokenæ˜¯å¦æœ‰æ•ˆ |
| `403 Forbidden`    | æƒé™ä¸è¶³     | ç¡®è®¤åº”ç”¨å…·æœ‰ç›¸åº”çš„è¯»å†™æƒé™       |
| `404 Not Found`    | èµ„æºä¸å­˜åœ¨   | æ£€æŸ¥Base Tokenæˆ–Table IDæ˜¯å¦æ­£ç¡® |
| `429 Rate Limited` | è°ƒç”¨é¢‘ç‡è¶…é™ | é™ä½APIè°ƒç”¨é¢‘ç‡ï¼Œè€ƒè™‘æ‰¹é‡æ“ä½œ    |

### è°ƒè¯•å»ºè®®

1.  **å¯ç”¨è¯¦ç»†æ—¥å¿—**: åœ¨å¼€å‘é˜¶æ®µå¯ç”¨å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—
2.  **æµ‹è¯•èŠ‚ç‚¹**: ä½¿ç”¨æµ‹è¯•åŠŸèƒ½éªŒè¯å•ä¸ªèŠ‚ç‚¹é…ç½®
3.  **ç›‘æ§é¢æ¿**: åˆ©ç”¨ n8n çš„æ‰§è¡Œç›‘æ§é¢æ¿åˆ†æé—®é¢˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.2.0

**æœ€åæ›´æ–°**: 2025-11-28

**ç»´æŠ¤äººå‘˜**: Admin

**ä¸»è¦æ›´æ–°å†…å®¹**:

*   **v1.2.0 (2025-11-28)**
    *   æ–°å¢ DeepSeek V3 æ¨¡å‹æ”¯æŒ (via OpenRouter)
    *   æ›´æ–° WF-04 ä¸ºäº‹ä»¶é©±åŠ¨æ¶æ„ (Webhook)
    *   æ–°å¢ WF-06 å‘¨äº”èµä¼‘æé†’æœåŠ¡
    *   æ›´æ–°æ—¶åŒºåŠè°ƒåº¦é…ç½®

*   **v1.1.0 (2025-11-10)**
    *   ç‰ˆæœ¬å·åŒæ­¥è‡³ â€œå®ˆæœ›è€…ç‰ˆâ€ï¼Œå†…å®¹ç»å®¡æŸ¥ä¸æ­¤ç‰ˆæœ¬å…¼å®¹ï¼Œæ— ç›´æ¥ä¿®æ”¹ã€‚

*   **v1.0.0 (2025-11-09)**
    *   é¡¹ç›®é¦–ä¸ªç¨³å®šç‰ˆæœ¬å‘å¸ƒã€‚
    *   ä¸ `v1.0.0` æ¶æ„è®¾è®¡åŠå·²éƒ¨ç½²å·¥ä½œæµçš„é…ç½®å®Œå…¨å¯¹é½ã€‚