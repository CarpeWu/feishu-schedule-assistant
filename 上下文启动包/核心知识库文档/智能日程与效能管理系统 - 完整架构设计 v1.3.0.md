# **智能日程与效能管理系统 - 完整架构设计 v1.3.0**

## **📋 设计概述**

**版本**: 1.3.0
**发布日期**: 2025-12-11
**设计原则**: **异步优先、精准路由、闭环反馈、AI 深度赋能**
**技术栈**: n8n + feishu-nodes-lite + **Lark Bitable (作为统一数据基座)** + **DeepSeek V3 (via OpenRouter)**

### **设计目标**

设计一套以快速交付和稳定运行为首要目标的 n8n 自动化工作流系统架构。本架构将聚焦于 MVP 的核心价值闭环，通过简化技术栈和统一数据源，确保系统在早期阶段的健壮性、可维护性和可观测性。

**v1.3.0 核心升级**:
1.  **架构稳健性**: 全面引入 **Fire & Forget (异步响应)** 模式，彻底解决飞书 Webhook 超时重试导致的重复执行问题。
2.  **审批闭环**: 新增 **T6 特殊日程审批流**，实现审批通过后自动通知相关人员，完善了考勤管理的最后一块拼图。

---

## **🏗️ 系统架构设计**

### **整体系统架构**

```mermaid
graph TD
    subgraph 用户交互层
        U1[飞书客户端/飞书应用]
    end
    
    subgraph 触发层
        T1[定时触发]
        T2[事件订阅]
    end

    subgraph 工作流引擎层
        WF1[WF-01 排班计算]
        WF2[WF-02 通知服务]
        WF3[WF-03 漏写判定]
        WF4[WF-04 统一事件处理]
        WF5[WF-05 AI深度分析]
        WF6[WF-06 赐休提醒]
    end
    
    subgraph 集成适配层
        I1[feishu-nodes-lite]
        I2[OpenRouter]
        I3[HTTP Request]
    end

    subgraph 数据存储层
        DB1[T1-T3: 结果与异常]
        DB2[T4: 过程追溯]
        DB3[T5-T7: 基础与配置]
    end
    
    %% 样式定义
    classDef db1 fill:#f9f,stroke:#333,stroke-width:2px
    classDef db2 fill:#ccf,stroke:#333,stroke-width:2px
    classDef db3 fill:#9f9,stroke:#333,stroke-width:2px
    
    %% 应用样式
    class DB1 db1
    class DB2 db2
    class DB3 db3
    
    %% 连接关系
    U1 --> T2
    T1 --> WF1
    T1 --> WF2
    T1 --> WF3
    T1 --> WF5
    T1 --> WF6
    T2 --> WF4
    
    WF1 --> I1
    WF1 --> I2
    WF1 --> I3
    
    WF2 --> I1
    WF2 --> I2
    WF2 --> I3
    
    WF3 --> I1
    WF3 --> I2
    WF3 --> I3
    
    WF4 --> I1
    WF4 --> I2
    WF4 --> I3
    
    WF5 --> I1
    WF5 --> I2
    WF5 --> I3
    
    WF6 --> I1
    WF6 --> I2
    WF6 --> I3
    
    I1 --> DB1
    I1 --> DB2
    I1 --> DB3
```

---

## **🔧 工作流模块设计**

### **[WF-01] 排班计算引擎模块**

*   **触发器**: 定时触发器，每日 **20:00** 执行。
*   **核心逻辑**: 计算当日应交日报的员工，并将结果写入 `T4:每日排班记录表`。
*   **排班规则**: 内置智能判断逻辑（代码级），识别单/双休及工作日，并结合 `T6:特殊日程表` 进行豁免处理。
*   **逻辑优化**: 增加了对特殊日程审批状态的校验，只有“已批准”的日程才会触发生效。

```mermaid
graph TD
    subgraph "WF-01: 排班计算引擎"
        A[Node 1: 每日20:00触发器] --> B[Node 2: 获取系统配置]
        B --> C[Node 3: 查询在职员工]
        C --> D[Node 4: 查询当日特殊日程]
        D --> E[Node 5: 排班逻辑计算]
        E --> F["<b>Node 6: 汇总排班结果 (Code)</b>"]
        F --> G[Node 7: 写入排班记录]
        G --> H[Node 8: 发送完成通知]
    end
```

### **[WF-02] 提醒与通知服务模块**

*   **触发器**: 定时（每日 **21:00** / **22:00 / 23:00**）。
*   **核心逻辑**: 在日报提交截止前，向当天应交但尚未提交日报的员工，发送一条**友好的提醒消息**，内含一个**指向主日报填写表单的链接**。
*   **去重机制**: 代码级智能防重，确保同一批次内不重复打扰同一员工。

```mermaid
flowchart TD
    subgraph "触发方式"
        A[定时触发器 21:00 / 22:00 / 23:00]
    end
    A --> C[<b>从T4表查询今日应交名单</b>]
    C --> D[查询T2表获取今日已提交名单]
    D --> E[Code: 筛选出未提交员工]
    E --> F{是否有未提交者?}
    F --是--> G[<b>发送提醒消息, 内含“填写日报”的表单链接</b>]
    G --> Z[结束]
    F --否--> Z[结束]
```

### **[WF-03] 漏写判定与记录服务模块**

*   **触发器**: 定时触发器，每日 **08:00** 执行。
*   **核心逻辑**: 对比**前一日**应交与实交记录，在 `T1:漏写记录表` 中为真正漏写的员工创建状态为“**漏写**”的记录，并发送补交通知。

```mermaid
flowchart TD
    A[定时触发器 次日08:00] --> B[从T4表查询昨日应交名单]
    B --> C[查询T2表获取昨日提交记录]
    C --> D[Code: 对比分析识别漏写员工]
    D --> E{是否有漏写员工?}
    
    subgraph "并行处理分支"
        E --是--> F["<b>Node 6: 创建漏写记录</b><br>(飞书多维表格)<br>批量新增"]
        E --是--> G["<b>Node 7: 发送员工漏写通知</b><br>(Code + 飞书消息)"]
    end

    F --> I[<b>Node 8: 向管理员发送漏写汇总报告</b>]
    I --> Z[结束]
    G --> Z
    E --否--> J[记录无漏写日志]
    J --> Z
```

### **[WF-04] 统一提交处理模块 (Event-Driven)**

*   **触发器**: Webhook 触发器，订阅飞书多维表格的**记录变更事件 (bitable.record.changed)**。
*   **核心升级 (v1.3.0)**:
    *   **异步响应**: 引入 `Respond to Webhook` 节点，收到事件后立即返回 200 OK，防止飞书超时重试。
    *   **Switch 路由**: 使用 Switch 节点替代 IF 级联，实现更清晰的多表事件分发。
    *   **T6 审批流**: 新增 T6 表变更处理逻辑，当特殊日程“审批通过”时，自动通知相关人员。

```mermaid
flowchart TD
    A["Webhook: 接收飞书事件订阅"] --> B["<b>Respond to Webhook</b><br>(立即返回 200 OK)"]
    B --> C{"<b>Switch: Table ID 路由</b>"}
    
    subgraph "分支一: T2 日报内容表"
        C -- "T2 Table" --> D["提取 User OpenID"]
        D --> E["获取 T2 记录详情"]
        E --> F{"Check: employee_ref?"}
        F -- "Empty" --> G["查询 T5 补充关联"]
        G --> H["更新 T2 employee_ref"]
        F -- "Exist" --> H
        H --> I{"判断提交类型"}
        
        I -- "补交/仅说明原因" --> J["查询 & 更新 T1 漏写记录"]
        J --> K["发送员工确认消息"]
        
        I -- "所有类型" --> L["通知管理员"]
    end

    subgraph "分支二: T5 员工信息表"
        C -- "T5 Table" --> M["提取变更人员信息"]
        M --> N{"校验有效性"}
        N -- "Valid" --> O["自动回写 OpenID & UserID 到 T5"]
    end

    subgraph "分支三: T6 特殊日程表 (新增)"
        C -- "T6 Table" --> P["<b>Code: 变更检测</b><br>(Check approval_status)"]
        P --> Q{"是否变为'已批准'?"}
        Q -- "Yes" --> R["获取 T6 记录详情"]
        R --> S["获取 T7 配置: CC_IDS"]
        S --> T["Code: Fan Out (分裂任务)"]
        T --> U["发送通知消息 (给申请人+抄送人)"]
    end
```

### **[WF-05] AI分析服务模块 (DeepSeek)**

*   **触发器**: 定时触发器（每日 09:00），代码级控制仅在**周一**（周总结）或**每月1日**（月总结）执行。
*   **核心逻辑**: 收集周期内日报数据，调用 **DeepSeek V3** 模型进行深度分析，生成 Summary 和 Insights，结果写入 `T3:AI分析汇总表`，并分别推送给员工本人和管理员。

```mermaid
flowchart TD
    A["定时触发 09:00"] --> B["Code: 判断日期 (周一/1号?)"]
    B -->|Yes| C["获取AI配置 & 计算日期范围"]
    C --> D["获取多周日报数据"]
    D --> E["Code: 按员工分组 & 格式化"]
    E --> F["AI Agent (DeepSeek V3)<br>深度分析 & 洞察生成"]
    F --> G["解析 AI 结果"]
    
    subgraph 结果分发
        G --> H["写入 T3: AI分析汇总表"]
        H --> I["向管理员发送汇总卡片"]
        G --> J["向员工发送个人分析周报"]
    end
```

### **[WF-06] 周五赐休提醒服务**

*   **触发器**: 定时触发器，每周五 **19:00**。
*   **核心逻辑**: 向指定管理员发送“赐休”提醒卡片，提示进行周末事务审批。

---

## **🗄️ 数据架构设计**

### **飞书多维表格完整字段设计**

### **第一优先级：结果与异常数据 (T1-T3)**

#### **T1: 漏写记录表**(TABLE_ID_PLACEHOLDER)
| 字段名                        | 字段类型         | 字段属性   | 说明                                               |
| ----------------------------- | ---------------- | ---------- | -------------------------------------------------- |
| **missed_log_id**             | 自动编号         | 主键       | 漏写记录的唯一ID                                   |
| **employee_ref**              | **多维表格关联** | 必填       | **系统关联**: 链接到`T5`表的`employee_id`主键      |
| **employee_person**           | **人员**         | 必填       | **界面显示**: 用于直观展示员工姓名和头像           |
| **missed_date**               | 日期             | 必填       | 漏写的具体日期                                     |
| status                        | 单选             | 必填       | 记录状态 (**漏写, 已说明原因, 已补交, 已豁免**)    |
| **resolving_submission_ref**  | **多维表格关联** | **可选**   | **系统关联**: 链接到`T2`表中解决此漏写事件的记录   |
| **makeup_explanation_lookup** | **查找引用**     | **(自动)** | **界面显示**: 自动从关联的`T2`记录中查找并显示原因 |
| **makeup_time**               | **日期时间**     | 可选       | 员工完成补交或说明原因的具体时间                   |
| exempt_reason                 | 文本             | 可选       | 管理员填写的豁免原因                               |
| exempt_by                     | 人员             | 可选       | 豁免审批人                                         |
| created_time                  | 创建时间         | 自动填充   | -                                                  |

#### **T2: 日报内容表**(TABLE_ID_PLACEHOLDER)
| 字段名                 | 字段类型         | 字段属性 | 说明                                               |
| ---------------------- | ---------------- | -------- | -------------------------------------------------- |
| **daily_report_id**    | 自动编号         | 主键     | 日报的唯一ID                                       |
| **employee_ref**       | **多维表格关联** | 必填     | **系统关联**: 链接到`T5`表的`employee_id`主键      |
| **employee_person**    | **人员**         | 必填     | **界面显示**: 用于直观展示员工姓名和头像           |
| **report_date**        | 日期             | 必填     | 日报对应的日期                                     |
| work_content           | 文本             | 可选     | 正常和补交时必填                                   |
| next_plan              | 文本             | 可选     | 正常和补交时必填                                   |
| **makeup_explanation** | **文本**         | **可选** | **补交或仅说明原因时填写。这是原因的唯一数据源。** |
| workload_feeling       | 单选             | 可选     | -                                                  |
| need_assistance        | 复选框           | -        | -                                                  |
| assistance_detail      | 文本             | 条件可选 | -                                                  |
| submission_type        | 单选             | 必填     | 提交类型 (**正常, 补交, 仅说明原因**)              |
| submit_time            | 日期时间         | 自动填充 | -                                                  |

#### **T3: AI分析汇总表**(TABLE_ID_PLACEHOLDER)
| 字段名                | 字段类型 | 字段属性 | 说明                                                     |
| --------------------- | -------- | -------- | -------------------------------------------------------- |
| **analysis_id**       | 自动编号 | 主键     | 分析报告的唯一ID                                         |
| analysis_type         | 单选     | 必填     | 分析类型 (个人, 团队)                                    |
| target_id             | 文本     | 必填     | 目标ID (员工ID或部门ID)，用于n8n处理                     |
| **target_person**     | **人员** | 条件可选 | **界面显示**: 当类型为“个人”时，关联`T5`表员工，方便查看 |
| **period_start_date** | 日期     | 必填     | 分析周期开始日期                                         |
| **period_end_date**   | 日期     | 必填     | 分析周期结束日期                                         |
| summary               | 文本     | 必填     | 分析摘要                                                 |
| insights              | 文本     | 必填     | 关键洞察                                                 |
| RECORD_ID_PLACEHOLDER       | 文本     | 必填     | 改进建议                                                 |
| report_url            | 超链接   | 可选     | 详细报告文档链接                                         |
| created_time          | 创建时间 | 自动填充 | -                                                        |

### **第二优先级：过程追溯与日志 (T4)**

#### **T4: 每日排班记录表**(TABLE_ID_PLACEHOLDER)
| 字段名              | 字段类型         | 字段属性   | 说明                                           |
| ------------------- | ---------------- | ---------- | ---------------------------------------------- |
| **schedule_log_id** | 自动编号         | 主键       | 排班记录的唯一ID                               |
| **schedule_date**   | 日期             | 必填, 索引 | 排班对应的日期                                 |
| **employee_ref**    | **多维表格关联** | 必填, 索引 | **系统关联**: 链接到`T5`表的`employee_id`主键  |
| **employee_person** | **人员**         | 必填       | **界面显示**: 用于直观展示员工姓名和头像       |
| status              | 单选             | 必填, 索引 | 当日状态。选项: `应交`, `休息`, `请假`, `特殊` |
| created_time        | 创建时间         | 自动填充   | -                                              |

### **第三优先级：基础信息与系统配置 (T5-T7)**

#### **T5: 员工信息表**(TABLE_ID_PLACEHOLDER)
| 字段名              | 字段类型     | 字段属性   | 说明与实践                                                |
| ------------------- | ------------ | ---------- | --------------------------------------------------------- |
| **employee_id**     | **文本**     | **主键**   | **系统业务主键** (如工号)，稳定、不变。将此列放在第一列。 |
| **employee_person** | **人员**     | 必填       | **员工核心字段**。包含姓名、头像，n8n写入用户Open ID。    |
| open_id             | 文本         | 索引, 唯一 | 飞书Open ID，用于API交互。                                |
| department          | **查找引用** | (自动)     | 自动从`employee_person`字段引用，与飞书通讯录同步。       |
| manager_person      | **查找引用** | (自动)     | 自动从`employee_person`字段引用，与飞书通讯录同步。       |
| email               | **查找引用** | (自动)     | 自动从`employee_person`字段引用，与飞书通讯录同步。       |
| shift_template      | 单选         | 必填       | 排班模板。                                                |
| status              | 单选         | 必填       | 在职状态 (在职, 离职)。                                   |
| **submitted_count** | 数字         | (未来增强) | 累计提交日报次数。                                        |
| **missed_count**    | 数字         | (未来增强) | 累计漏写日报次数。                                        |
| created_time        | 创建时间     | 自动填充   | -                                                         |

#### **T6: 特殊日程表**(TABLE_ID_PLACEHOLDER)
| 字段名                   | 字段类型         | 字段属性 | 说明                                          |
| ------------------------ | ---------------- | -------- | --------------------------------------------- |
| **special_schedule_id**  | 自动编号         | 主键     | 特殊日程の唯一ID                              |
| **employee_ref**         | **多维表格关联** | 必填     | **系统关联**: 链接到`T5`表的`employee_id`主键 |
| **employee_person**      | **人员**         | 必填     | **界面显示**: 用于直观展示员工姓名和头像      |
| **schedule_change_date** | 日期             | 必填     | 日程变更的具体日期                            |
| schedule_type            | 单选             | 必填     | 日程类型 (请假, 出差, 调休, 特殊排班, 节假日) |
| reason                   | 文本             | 可选     | 原因说明                                      |
| approver_person          | 人员             | 可选     | 审批人                                        |
| approval_status          | 单选             | 必填     | 状态 (待审批, 已批准, 已驳回)                 |
| created_time             | 创建时间         | 自动填充 | -                                             |

#### **T7: 系统配置参数表**(TABLE_ID_PLACEHOLDER)
| 字段名          | 字段类型 | 字段属性   | 说明                                             |
| --------------- | -------- | ---------- | ------------------------------------------------ |
| **config_id**   | 自动编号 | 主键       | 配置项的唯一ID                                   |
| parameter_name  | 文本     | 必填, 唯一 | 参数名称，供n8n调用                              |
| parameter_value | 文本     | 必填       | 参数值。例如: `ADMIN_OPEN_IDS`, `REMINDER_TIMES` |
| description     | 文本     | 必填       | 参数描述，说明用途和格式                         |
| category        | 单选     | 必填       | 配置分类 (排班, 通知, AI, 系统)                  |
| modified_time   | 修改时间 | 自动填充   | -                                                |

**新增参数示例 (v1.3.0)**:
*   Parameter: `SPECIAL_SCHEDULE_CC_IDS`
*   Value: `ou_xxx,ou_yyy`
*   Description: `[WF-04] 特殊日程审批通过后的抄送对象`

---

## **🚀 后续演进与规划**

本部分用于记录在 `v1.0.0` 之后可以引入的增强功能，以确保优秀的想法不会被遗忘。

### **1. 员工日报统计功能**

*   **目标**: 长期追踪并量化每位员工的日报提交和漏写情况，为绩效评估或管理谈话提供数据支持。
*   **数据模型变更**:
    *   在 `T5:员工信息表` 中，已预留 `submitted_count` 和 `missed_count` 两个数字类型字段。
*   **工作流逻辑变更**:
    *   **WF-04 (统一提交处理)**: 在每次成功写入 `T2:日报内容表` 且`submission_type`为“正常”或“补交”时，增加一个步骤，将其`submitted_count`字段的值加 1。
    *   **WF-03 (漏写判定)**: 在每次成功写入 `T1:漏写记录表` 后，增加一个步骤，将其`missed_count`字段的值加 1。

---

## **🔧 技术与部署**

### **技术选型与错误处理**
*   **工作流引擎**: n8n (自托管 Docker 版本)。
*   **核心集成**: `n8n-nodes-feishu-lite`, `OpenRouter (DeepSeek V3)`.
*   **数据库**: 飞书多维表格 (Lark Bitable)。
*   **错误处理**: 采用**节点级重试**（`Retry On Fail`）和**工作流级告警**（`Error Workflow`）相结合的策略。
*   **[核心最佳实践]** **执行一次（Execute Once）**: 对于接收多项输入但自身逻辑只应执行一次的节点（如批量创建、汇总报告），**必须**在其 Settings 中开启 Execute Once 选项，以防止因上游输出多项item而导致节点被重复执行。

### **权限与部署**
*   **权限控制**: **完全依赖飞书多维表格的原生权限管理能力**。
*   **部署架构**: 采用**Docker**在云服务器部署n8n单实例容器，区分**开发**与**生产**两套环境及对应的数据表。

---

## **📝 版本修订历史**

*   **v1.3.0 (2025-12-11) - “进化版 (Evolution Edition)”**
    - **[WF-04 架构重构]** 引入异步响应 (Respond to Webhook) 和 Switch 路由，从根本上解决了 Webhook 超时问题。
    - **[新增功能]** 完善了 T6 特殊日程的审批闭环，新增“审批通过通知抄送”功能。
    - **[数据升级]** T7 表新增 `SPECIAL_SCHEDULE_CC_IDS` 配置项。
*   **v1.2.0 (2025-11-28) - “智识版 (Cognition Edition)”**
    - **[WF-04 架构重构]** 升级为双通道事件处理架构。
    - **[WF-05 AI 升级]** 模型升级为 **DeepSeek V3**。
*   **v1.1.0 (2025-11-10) - “守望者版”**
    - **[WF-04 架构升级]** 将 WF-04 的触发机制升级为响应飞书事件订阅的模式，并增加“门卫”节点。
*   **v1.0.0 (2025-11-09)**
    - 项目首个稳定版本 **“黎明版 (Daybreak Edition)”** 发布。
