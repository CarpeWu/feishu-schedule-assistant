### **Optimized Phase-Based Task Prompts v1.3.0**

---

### **Universal Technical & Interaction Rules (Reminder for all Phases)**

Expert, remember the "Main Role & Rules" prompt v1.3.0. For every phase below, you must strictly adhere to the following:
1.  **Interaction Model:** First provide the **Mermaid diagram**, then provide the **visual configuration for the first node**, then **stop and wait** for my JSON output before proceeding to the next node.
2.  **Source of Truth:** All implementations **must** be based on the provided knowledge base, primarily the `架构设计 v1.3.0.md`, `API配置文档 v1.3.0.md`, and the `权威技术规范 v1.3.0.md`.
3.  **Output Format:** All node configurations must be presented as a **visual, step-by-step guide** in the specified list format.
4.  **Node Names:** Use the correct **中文** names for `feishu-nodes-lite` community nodes (e.g., "飞书多维表格").

### **Pre-computation & Verification Step**

Before you provide the configuration for any node, you must perform this internal verification step:
1.  **Search & Verify:** First, use your search capabilities to consult the latest official n8n and Feishu/Lark API documentation for the nodes and operations involved.
2.  **Cross-Reference:** Cross-reference this information with the provided project documents to ensure complete alignment.
3.  **Declare Completion:** Begin your response with the phrase: "**已根据最新的官方文档及项目架构文档完成验证。**"

---

### **[Phase 1: WF-01] 每日排班计算引擎**

**Mission Brief:**
Expert, we will now implement **[WF-01] 排班计算引擎**. Your task is to guide me in building the workflow that calculates which employees need to submit a daily report today and records this schedule.

**Node-by-Node Requirements (from `架构设计 v1.3.0.md`):**

1.  **Node 1: 定时触发 (Schedule Trigger)**
    *   **Trigger Time:** Daily at **20:00** Asia/Shanghai time.
2.  **Node 2-4: 数据获取 (飞书多维表格 x3)**
    *   **Logic:** Sequentially query `T7` for configs, `T5` for active employees, and `T6` for special schedules.
3.  **Node 5: 排班逻辑计算 (Code)**
    *   **Logic:** Filter employees based on exemptions and their `shift_template`.
4.  **Node 6: 汇总排班结果 (Code)**
    *   **Purpose:** Convert the multi-item stream into a single-item stream.
5.  **Node 7: 写入排班记录 (飞书多维表格)**
    *   **Action:** 批量新增记录 (Batch Add Records) into `T4`.
    *   **Critical Setting:** **`Execute Once` must be enabled**.
6.  **Node 8-10: 发送完成通知**
    *   **Logic:** Notify administrators of successful completion.

**Your First Step:**
Please begin by providing the **Mermaid diagram** for this workflow.

---

### **[Phase 2: WF-02] 提醒与通知服务模块**

**Mission Brief:**
Expert, we will now implement **[WF-02] 提醒与通知服务**. Your task is to build the workflow that finds employees who haven't submitted their reports yet and sends them a friendly, same-day reminder.

**Node-by-Node Requirements (from `架构设计 v1.3.0.md`):**

1.  **Node 1: 定时触发 (Schedule Trigger)**
    *   **Trigger Time:** Daily at **21:00, 22:00, and 23:00**.
2.  **Node 2 & 3: 数据获取 (飞书多维表格 x2)**
    *   **Logic:** Sequentially query `T4` for today's scheduled list and `T2` for today's submitted list.
3.  **Node 4: 筛选未提交员工 (Code)**
    *   **Logic:** Compare the two lists to identify who needs a reminder.
4.  **Node 5-7: 发送提醒 (IF -> Code -> 飞书消息)**
    *   **Logic:** If the "unsubmitted" list is not empty, loop through each employee to prepare and send a reminder card.

**Your First Step:**
Please begin by providing the **Mermaid diagram** for this workflow.

---

### **[Phase 3: WF-03] 漏写判定与记录服务模块**

**Mission Brief:**
Expert, we will now implement **[WF-03] 漏写判定与记录服务**. This workflow runs the following morning, identifies who missed their report, and then processes them **in parallel**: (A) creating all missed records in a single batch, and (B) looping to send individual notifications.

**Node-by-Node Requirements (from `架构设计 v1.3.0.md`):**

1.  **Node 1: 定时触发 (Schedule Trigger)**
    *   **Trigger Time:** Daily at **08:00** Asia/Shanghai time.
2.  **Node 2 & 3: 数据获取 (飞书多维表格 x2)**
    *   **Logic:** Sequentially query `T4` for `Yesterday`'s scheduled list and `T2` for `Yesterday`'s submitted list.
3.  **Node 4: 对比分析识别漏写员工 (Code)**
    *   **Logic:** Compare the lists to find who has missed their report.
4.  **Node 5: 条件判断 (IF)**
    *   **Condition:** Check if the list of missed employees is not empty.

**--== Parallel Branch A: Batch Record Creation (Executes ONCE) ==--**
5.  **Node 6: 创建漏写记录 (飞书多维表格)**
    *   **Action:** 批量新增记录 (Batch Add Records) into `T1`.
    *   **Critical Setting:** **`Execute Once` must be enabled**.
6.  **Node 7-9: 向管理员发送汇总报告**
    *   **Logic:** After creating records, notify admins with a summary.
    *   **Critical Setting:** The message node must have **`Execute Once` enabled**.

**--== Parallel Branch B: Per-Employee Notification (Loops) ==--**
7.  **Node 10 & 11: 准备并发送员工通知 (Code -> 飞书消息)**
    *   **Logic:** For each missed employee, prepare and send a notification card.

**Your First Step:**
Please begin by providing the **Mermaid diagram** for this workflow.

---

### **[Phase 4: WF-04] 统一提交处理模块 (v1.3.0)**

**Mission Brief:**
Expert, we will now implement the upgraded **[WF-04] 统一提交处理**. This workflow has been re-architected in v1.3.0 to use an **Async First** and **Event Routing** pattern. It handles T2 report submissions, T5 employee info updates, and T6 special schedule approvals.

**Node-by-Node Requirements (from `架构设计 v1.3.0.md`):**

**Block A: Async Gateway & Routing**
1.  **Node 1: Webhook触发 (Webhook)**
    *   **Trigger:** Receives a payload from the Feishu Event Subscription for `bitable.record.changed`.
2.  **Node 2: 异步响应 (Respond to Webhook)**
    *   **Action:** Immediately return `200 OK`. This is crucial to prevent Feishu from retrying due to timeout.
3.  **Node 3: 事件路由 (Switch)**
    *   **Logic:** Route based on `table_id`.
    *   **Output 0:** T2: 日报内容表 (`TABLE_ID_PLACEHOLDER`)
    *   **Output 1:** T5: 员工信息表 (`TABLE_ID_PLACEHOLDER`)
    *   **Output 2:** T6: 特殊日程表 (`TABLE_ID_PLACEHOLDER`)

**Block B: T2 Report Submission Path**
4.  **Node 4: 提取User OpenID (Code)**
    *   **Action:** Extracts user info from the webhook payload.
5.  **Node 5: 获取T2记录详情 (飞书多维表格)**
    *   **Target:** `T2: 日报内容表`.
6.  **Node 6-8: 自动关联处理 (IF -> 查询T5 -> 更新T2)**
    *   **Logic:** If `employee_ref` is empty, auto-link it using the extracted OpenID.
7.  **Node 9-11: 业务逻辑处理 (IF -> 漏写销号/管理员通知)**
    *   **Logic:** Check `submission_type`. If "補交", update T1. Always notify admins.

**Block C: T5 Employee Info Auto-Update Path**
8.  **Node 12: 提取变更人员信息 (Code)**
    *   **Logic:** Parses the webhook `action_list` to identify actual changes in person fields.
9.  **Node 13: 校验有效性 (IF)**
    *   **Condition:** Checks if a valid `employee_person` change was detected.
10. **Node 14: 回写工号与OpenID (飞书多维表格)**
    *   **Action:** Updates `employee_id` and `open_id` in T5.

**Block D: T6 Special Schedule Approval Path (New in v1.3.0)**
11. **Node 15: 变更检测 (Code)**
    *   **Logic:** Check if `approval_status` changed to "已批准". Use `Run Once for All Items`.
12. **Node 16: 批准生效? (IF)**
    *   **Condition:** If the previous node returned any items.
13. **Node 17: 获取T6详情 (飞书多维表格)**
    *   **Target:** `T6: 特殊日程表`.
14. **Node 18: 获取系统配置 (飞书多维表格)**
    *   **Target:** `T7: 系统配置参数表`. Fetch `SPECIAL_SCHEDULE_CC_IDS`.
15. **Node 19: Fan Out 分裂任务 (Code)**
    *   **Logic:** Split the CC IDs into multiple items for individual messaging. Use `Run Once for All Items`.
16. **Node 20: 发送通知消息 (飞书消息)**
    *   **Recipient:** The CC'd user (and potentially the applicant).

**Your First Step:**
Please begin by providing the **Mermaid diagram** for this workflow, reflecting the new v1.3.0 architecture.

---

### **[Phase 5: WF-05] AI分析服务模块**

**Mission Brief:**
Expert, for our final phase, we will implement **[WF-05] AI分析服务**. This workflow will periodically collect report data, send it to **DeepSeek V3** for analysis, and store the results, also notifying both administrators and the individual employee.

**Node-by-Node Requirements (from `架构设计 v1.3.0.md`):**

1.  **Node 1: 定时触发 (Schedule Trigger)**
    *   **Trigger Time:** Daily at **09:00**. Internal code ensures execution only on Monday (weekly) or the 1st of the month (monthly).
2.  **Node 2: 判断执行类型 (Code)**
    *   **Logic:** Determines if it's a weekly or monthly summary day.
3.  **Node 3: 今天需要执行总结吗? (IF)**
    *   **Condition:** Checks if `shouldRun` is true from the previous node.
4.  **Node 4: 是月总结还是周总结? (IF)**
    *   **Condition:** Routes based on `runType`.
5.  **Node 5: 获取AI分析配置 (飞书多维表格)**
    *   **Target:** `T7: 系统配置参数表`.
    *   **Logic:** Fetches AI-related configurations.
6.  **Node 6: 计算日期范围 (Code)**
    *   **Logic:** Dynamically calculates the start and end dates for data collection based on weekly/monthly type.
7.  **Node 7: 获取多周日报数据 (飞书多维表格)**
    *   **Target:** `T2: 日报内容表`.
    *   **Logic:** Retrieves report data within the calculated date range.
8.  **Node 8: 按员工分组并格式化日报 (Code)**
    *   **Logic:** Groups reports by employee and formats them into a text string suitable for AI input, including "historical context" and "current week" sections.
9.  **Node 9: AI Agent (DeepSeek V3)**
    *   **Model:** `deepseek/deepseek-chat-v3.1` (via OpenRouter).
    *   **Prompt:** Uses a highly specialized prompt to analyze work content, identify trends, and generate summary/insights.
10. **Node 10: 解析AI分析结果 (Code)**
    *   **Logic:** Parses the JSON output from the AI agent and attaches employee information.
11. **Node 11: 准备写入数据 (Code)**
    *   **Logic:** Formats the AI analysis results into the structure required for `T3`.
12. **Node 12: 写入T3分析汇总表 (飞书多维表格)**
    *   **Action:** Batch Add Records into `T3`. **`Execute Once` must be enabled**.
13. **Node 13: 查询管理员名单 (飞书多维表格)**
    *   **Target:** `T7: 系统配置参数表`.
    *   **Logic:** Retrieves `ADMIN_OPEN_IDS`.
14. **Node 14: 准备管理员通知卡片 (Code)**
    *   **Logic:** Formats a detailed message card for administrators, including AI summary and insights.
15. **Node 15: 向管理员发送通知 (飞书消息)**
16. **Node 16: 准备员工通知卡片 (Code)**
    *   **Logic:** Formats a personalized message card for the employee with their AI summary and insights.
17. **Node 17: 向员工发送周报总结 (飞书消息)**

**Your First Step:**
Please begin by providing the **Mermaid diagram** for this workflow.
